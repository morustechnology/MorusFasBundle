{% extends '::base.html.twig' %}

{% form_theme unit_form 'MorusFasBundle:Statement:layout.html.twig' %}

{% set prod_dlg_btn_prfx = 'fas_inv_dlg_btn_' %}
{% set prod_dlg_btn_id = prod_dlg_btn_prfx ~ '%itemcode%_%index%' %}
{% set prod_dlg_idx_id = 'fas_inv_dlg_idx' %}
{% set prod_dlg_div_id = 'fas_inv_dlg_div' %}

{% set prod_new_div = 'fas_inv_new_div' %}
{% set prod_db_tbl_id = 'fas_inv_prod_db_tbl' %}
{% set prod_new_tbl_id = 'fas_inv_prod_new_tbl' %}

{% set vec_dlg_div_id = 'fas_vec_dlg_div' %}
{% set vec_dlg_new_cust_div_id = 'fas_vec_dlg_new_cust_div' %}
{% set vec_dlg_exist_cust_div_id = 'fas_vec_dlg_exist_cust_div' %}
{% set vec_dlg_cust_select_id = 'fas_vec_dlg_cust_select' %}
{% set vec_dlg_cust_radio_id = 'fas_vec_dlg_cust_radio' %}

{% set vec_dlg_lic_ul_id = 'fas_vec_dlg_lic_ul' %}
{% set vec_dlg_btn_id = 'fas_vec_dlg_btn' %}

{% block stylesheets %}
    {% stylesheets '@CraueFormFlowBundle/Resources/assets/css/buttons.css' %}
        <link type="text/css" rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
    
    {% stylesheets '@MorusFasBundle/Resources/public/css/jquery-ui.min.css' %}
        <link type="text/css" rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
{% endblock %}

{% block javascripts %}
    {% javascripts 
        '@MorusFasBundle/Resources/public/js/jquery-1.9.1.min.js'
        '@MorusFasBundle/Resources/public/js/jquery-ui.min.js'
        '@MorusFasBundle/Resources/public/js/jquery.inputmask.js'
        '@MorusFasBundle/Resources/public/js/jquery.inputmask.numeric.extensions.js'
    %}
        <script type="text/ecmascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}

    <script type='text/javascript'>
        var $vecDlg, $vecBtn, $vecDlgLic, $vecDlgLicUl, $vecDlgCustSelect;
        var $addChoice = 'existing';
        // ==========================================
        // Assign Vehicle JQuery Function
        // ==========================================
        jQuery(document).ready(function() {
            $vecDlg = $( "#{{ vec_dlg_div_id }}" );
            $vecBtn = $( '#{{ vec_dlg_btn_id }}');
            $vecDlgLic = $( '#{{ vec_dlg_btn_id }}');
            $vecDlgLicUl = $( '#{{ vec_dlg_lic_ul_id }}');
            $vecDlgCustSelect = $( '#{{ vec_dlg_cust_select_id }}');
            
            $vecDlg.css({overflow:"auto"}); // Make dialog scrollable
            $vecDlg.dialog({ //Init Dialog Box
                autoOpen: false, height: 300, width: 900, modal: true,
                buttons: {
                    "{{ 'btn.save'|trans }}": function() {
                        var licAry = $vecDlg.data('licences');
                        
                        if ($addChoice === 'existing') {
                            var unitname = $vecDlgCustSelect.find('option:selected').text();
                            var unitid = $vecDlgCustSelect.find('option:selected').val();
                            alert('test');
                            addToCustomer( unitid, licAry, function( response ){
                                alert('response');
                                if (response.success) {
                                    $.each(licAry, function(key, value){
                                        $('input[id="'+key+'"]').replaceWith(
                                            {% image '@MorusFasBundle/Resources/public/images/ok_icon_16x16.png' %}
                                                "<img src='{{ asset_url }}' alt='OK' style='width: 16px'/>"
                                            {% endimage %}
                                                );
                                    });
                                    
                                    $vecDlg.dialog( "close" );
                                }
                            });
                            
                        } else if ($addChoice === 'new') {
                            $vecDlg.dialog( "close" );
                        } 
                        
                    },
                    "{{ 'btn.cancel'|trans }}": function() {
                        $vecDlg.dialog( "close" );
                    }
                },
                show: { effect: "fade", duration: 500 },
                hide: { effect: "fade", duration: 500 }
            });
            
            // New Unit Popup Button
            $vecBtn.on('click', function(event){
                event.preventDefault();
                
                //  Get selected licences
                var licAry = {};
                $('input[name="licence_number_input"]:checked').each(function(event) {
                    licAry[this.id] = this.value;
                 });
                
                // Show Licences to dialog box list
                $vecDlgLicUl.empty();
                $.each(licAry, function(key, value){
                    $vecDlgLicUl.append('<li>'+value+'</li>'); 
                });
                
                
                $vecDlg.data('licences', licAry)
                        .dialog( "open" );
            });
            
            // Choose Customer Radio Button
            $('input[id="{{ vec_dlg_cust_radio_id }}"]').change(function(){
                if (this.value === 'new') {
                    $('#{{ vec_dlg_new_cust_div_id }}').show();
                    $('#{{ vec_dlg_exist_cust_div_id }}').hide();
                    $addChoice = this.value;
                } else {
                    $('#{{ vec_dlg_new_cust_div_id }}').hide();
                    $('#{{ vec_dlg_exist_cust_div_id }}').show();
                    $addChoice = this.value;
                }
            })
            
            
            
            // Post Form and get result
            function addToCustomer( unitId, licences, callback ){
                alert('inside function addToCustomer');
                // Get all form values
                var values = {};

                values['id'] = unitId;
                values['licences'] = licences;
                alert('{{ path('morus_fas_statement_add_vehicle_to_customer_ajax') }}');
                // Throw the form values to the server
                $.ajax({
                    url         : "{{ path('morus_fas_statement_add_vehicle_to_customer_ajax') }}",
                    type        : "POST",
                    data        : values,
                    success     : function(response) {
                        callback( jQuery.parseJSON(response) );
                    }
                });
            }
        });
        
        
        // ==========================================
        // New Product JQuery Function
        // ==========================================
        jQuery(document).ready(function() {
            var newProdAry = [];

            // Loop New Product Table
            $('#{{ prod_new_tbl_id }} > tbody  > tr').each(function() {
                newProdAry.push(this.id);
            });
            
            // Init New Product Dialog Box
            $( "#{{ prod_dlg_div_id }}" ).dialog({
                autoOpen: false,
                height: 200,
                width: 500,
                modal: true,
                buttons: {
                    "{{ 'btn.save'|trans }}": function() {
                        
                        $('#{{ parts_form.vars.attr.id }}').find(':submit').click();
                    },
                    "{{ 'btn.cancel'|trans }}": function() {
                        $( "#{{ prod_dlg_div_id }}" ).dialog( "close" );
                    }
                },
                show: {
                    effect: "fade",
                    duration: 500
                },
                hide: {
                    effect: "fade",
                    duration: 500
                }
            });
            
            // Add New Item button
            $( 'button[id^="{{ prod_dlg_btn_prfx }}"]' ).on('click', function( event ){
                event.preventDefault();
                
                var index = this.id.substring(this.id.lastIndexOf('_') + 1);
                var itemcode = this.id.replace("{{ prod_dlg_btn_prfx }}","").replace('_' + index, "" );
                var itemname = this.name;
                $('#{{ parts_form.vars.attr.id }}').find('#{{ prod_dlg_idx_id }}').val(index);
                $('#{{ parts_form.vars.attr.id }}').find('#{{ parts_form.itemcode.vars.id }}').val(itemcode);
                $('#{{ parts_form.vars.attr.id }}').find('#{{ parts_form.itemname.vars.id }}').val(itemname);
                $('#{{ parts_form.vars.attr.id }}').find('#{{ parts_form.defaultDiscount.vars.id }}').val('');
                
                $( "#{{ prod_dlg_div_id }}" ).dialog( "open" );
            });
            
            // Init Dialog Box -> New item form submit action
            $('#{{ parts_form.vars.attr.id }}').submit(function(event) {
                event.preventDefault();
                
                postForm( $(this), function( response ){
                    
                    if (response.success) {
                        var rIndex, rItemcode, rItemname, rDiscount;
                        rIndex = response.index;
                        rItemcode = response.itemcode;
                        rItemname = response.itemname;
                        rDiscount = response.discount;
                        updateProd(rIndex, rItemcode, rItemname, rDiscount);
                        $( "#{{ prod_dlg_div_id }}" ).dialog( "close" );
                    } else {
                        
                    }
                    
                });

                return false;
            }); 
            
            // Apply input mask to default discount box
            $('#{{ parts_form.defaultDiscount.vars.id }}').inputmask("decimal", { 
                radixPoint: ".", 
                groupSeparator: ",",
                groupSize: 3,
                digits: 2,
                autoGroup: true,
                placeholder: "0.00"
            });
            
            // Add New Row to Database Table
            function updateProd( index, itemcode, itemname, discount) {
                
                // Prepare Row and add to product table
               {% image '@MorusFasBundle/Resources/public/images/ok_icon.png' %}
                    var ok_icon_img = $("<img src='{{ asset_url }}' alt='OK' style='width: 15px'/>");
               {% endimage %}
               
                var jRow = $('<tr><td></td><td>' + itemcode + '</td><td>' + itemname + '</td><td>' + discount + '</td></tr>');
                $('td:last', jRow).append(ok_icon_img);
                $('#{{ prod_db_tbl_id }} tr:last').after(jRow);
                
                
                
                
                // Remove new product and update List 
                $( 'tr[id="' + index + '"]' ).remove();
                var i = newProdAry.indexOf(index);
                if ( i > -1 ) { newProdAry.splice(i, 1); }
                if ( newProdAry.length <= 0) {
                    $('div[id="{{ prod_new_div }}"]').remove();
                }
            }
            
            // Post Form and get result
            function postForm( $form, callback ){
                
                // Get all form values
                var values = {};
                var index = $form.find('#{{ prod_dlg_idx_id }}').val();
                values['index'] = index;
                $.each( $form.serializeArray(), function(i, field) {
                  values[field.name] = field.value;
                });

                // Throw the form values to the server
                $.ajax({
                    type        : $form.attr( 'method' ),
                    url         : $form.attr( 'action' ),
                    data        : values,
                    success     : function(response) {
                        callback( jQuery.parseJSON(response) );
                    }
                });
            }
        });
    </script>
{% endblock %}

{% block body_title -%}
    {{ 'statement.export_invoice'|trans }}
{% endblock %}

{% block body -%}
    
    <div>
        {% include 'CraueFormFlowBundle:FormFlow:stepList.html.twig' %}
    </div>
    {{ form_start(export_form) }}
        {{ form_errors(export_form) }}        
        
        {% if flow.getCurrentStepNumber() == 1 %} {# Product Search Step #}
            <h1>{{ 'export_step.search_result'|trans }}</h1>
            <hr/>
            
           <h3>{{ 'export_step.database_product'|trans }}</h3>
           <table id="{{ prod_db_tbl_id }}">
                <tr>
                    <th></th>
                    <th>{{ 'inventory.itemcode'|trans }}</th>
                    <th>{{ 'inventory.itemname'|trans }}</th>
                    <th>{{'inventory.default_discount'|trans }}</th>
                </tr>

                {% for prod in flow.prodList %}
                <tr>
                    <td>{{ prod.parts.itemcode }}</td>
                    <td>{{ prod.parts.itemname }}</td>
                    <td>${{ prod.defaultDiscount|number_format(2, '.', ',') }}</td>
                    <td>
                        {% image '@MorusFasBundle/Resources/public/images/ok_icon.png' %}
                            <img src="{{ asset_url }}" alt="OK" style="width: 15px"/>
                        {% endimage %}
                    </td>
                </tr>
                {% endfor %}
            </table>
            
            <br/><br/>
            

            <div id="{{ prod_new_div }}">
                <h3>{{ 'export_step.new_product'|trans }}</h3>
                <table id="{{ prod_new_tbl_id }}">
                    {% for itemcode, itemname in flow.newProdList %}
                        <tr id="{{ loop.index }}">
                            <td>
                                {% image '@MorusFasBundle/Resources/public/images/new_icon.png' %}
                                    <img src="{{ asset_url }}" alt="OK" style="width: 25px"/>
                                {% endimage %}
                            </td>
                            <td>{{ itemname }}</td>
                            <td>
                                <button id="{{ prod_dlg_btn_id|replace({'%itemcode%' : itemcode, '%index%' : loop.index}) }}" name="{{ itemname }}"  />+</button>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        {% elseif flow.getCurrentStepNumber() == 2 %}  {# Licence Search Step #}
            <button id="{{ vec_dlg_btn_id }}" >Add New Customer</button>
            <table>
                {% for row in flow.newVceList|batch(5) %}
                    <tr>
                        {% for vcecode, vcename in row %}
                        <td>
                            <input id="{{ vcecode }}" name="licence_number_input" type="checkbox" value="{{ vcename }}" />{{ vcename }}
                        </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>
        {% endif %}

        {{ form_rest(export_form) }}

        {% include 'CraueFormFlowBundle:FormFlow:buttons.html.twig' %}
    {{ form_end(export_form) }} 
    
    {#  New Product Popup #}
    <div id="{{ prod_dlg_div_id }}" title="{{ 'inventory.new.new_inventory_item'|trans }}" style="display:none">  
        {{ form_start(parts_form) }}
            {{ form_errors(parts_form) }}
            <input type="hidden" id="{{ prod_dlg_idx_id  }}" value="" />
            {{ 'inventory.itemcode'|trans }} {{ form_widget(parts_form.itemcode) }}{{ form_errors(parts_form.itemcode) }}
            {{ 'inventory.itemname'|trans }} {{ form_widget(parts_form.itemname) }} {{ form_errors(parts_form.itemname) }}
            <hr/>
            {{ 'inventory.default_discount'|trans }} {{ form_widget(parts_form.defaultDiscount) }}
            <br/>
            {{ form_widget( parts_form.submit ) }}
            {{ form_rest(parts_form) }}
        {{ form_end(parts_form) }}
    </div>
    
    {# Assign Licence to Customer Popup #}
    <div id="{{ vec_dlg_div_id }}" title="{{ 'contact.add_contact'|trans }}" style="display:none">
        <div id="container-box" class="contact-new">
            <div class="section-form inset form">
                {# Division to hold licence numbers #}
                <div>
                    {{ 'statement.selected_licence_list'|trans }} :
                    <ul id="{{ vec_dlg_lic_ul_id }}">

                    </ul>
                </div>
                {{ 'statement.add_to'|trans }}
                <fieldset >
                    <input type="radio" id="{{ vec_dlg_cust_radio_id }}" name="{{ vec_dlg_cust_radio_id }}"  value="existing" checked="checked" >{{ 'statement.existing_customer'|trans }}</input>
                    <input type="radio" id="{{ vec_dlg_cust_radio_id }}" name="{{ vec_dlg_cust_radio_id }}"  value="new">{{ 'statement.new_customer'|trans }}</input>
                </fieldset>

                
                {# Division for existing customer #}
                <div id="{{ vec_dlg_exist_cust_div_id }}" >
                    <select id="{{ vec_dlg_cust_select_id }}">
                        {% for unit in existing_units %}
                            <option value="{{ unit.id }}" >{{ unit.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                {# Division for creating new customer #}
                <div id="{{ vec_dlg_new_cust_div_id }}" style="display:none">
                    {{ form_start(unit_form) }}
                    {{ form_errors(unit_form) }}
                        <fieldset>
                            <div class="field long">
                                <label>{{ 'contact.display_name'|trans }}</label>

                                {{ form_widget(unit_form.name) }} {{ form_errors(unit_form.name) }}
                            </div>
                        </fieldset>


                        <div id="entity_persons" data-prototype-persons="">
                            {% for person in unit_form.persons %}
                                {% if loop.index == 1 %}
                                    <h4>{{ 'contact.primary_person'|trans }}</h4>
                                {% endif %}
                                <div id="entity_person_contacts" data-prototype-contacts="">
                                    <fieldset>
                                        {{ form_widget(person) }}
                                        {% for contact in person.contacts %}
                                            <div class="field inline long">{{ form_widget(contact) }}</div>
                                        {% endfor %}
                                    </fieldset>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="column">

                            {% for location in unit_form.locations %}
                                {{ form_widget(location) }}
                            {% endfor %}

                            <div class="col-1-3 last">
                                <fieldset id="numbers">
                                    <h6>{{ 'contact.others'|trans }}</h6>
                                    {% for contact in unit_form.contacts %}
                                        <div class="field">{{ form_widget(contact) }}</div>
                                    {% endfor %}
                                </fieldset>
                            </div>

                        </div>

                        <div>

                        </div>
                        {{ form_widget(unit_form.submit) }}

                        {{ form_rest(unit_form) }}
                    {{ form_end(unit_form) }}
                </div>
            </div>
        </div>
    </div>
        
{% endblock %}
