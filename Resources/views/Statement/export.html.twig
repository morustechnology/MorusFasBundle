{% extends '::base.html.twig' %}

{% form_theme unit_form 'MorusFasBundle:Statement:layout.html.twig' %}

{# Product Popup Dialog #}
{% set prod_dlg_btn_prfx = 'fas_inv_dlg_btn_' %}
{% set prod_dlg_btn_id = prod_dlg_btn_prfx ~ '%itemcode%_%index%' %}
{% set prod_dlg_idx_id = 'fas_inv_dlg_idx' %}
{% set prod_dlg_div_id = 'fas_inv_dlg_div' %}

{# Unit/Vehicle Pupup Dialog #}
{% set vec_dlg_div_id = 'fas_vec_dlg_div' %}
{% set vec_dlg_cust_new_div_id = 'fas_vec_dlg_cust_new_div' %}
{% set vec_dlg_exist_cust_div_id = 'fas_vec_dlg_exist_cust_div' %}
{% set vec_dlg_cust_select_id = 'fas_vec_dlg_cust_select' %}
{% set vec_dlg_cust_radio_id = 'fas_vec_dlg_cust_radio' %}
{% set vec_dlg_lic_ul_id = 'fas_vec_dlg_lic_ul' %}
{% set vec_dlg_btn_id = 'fas_vec_dlg_btn' %}

{# Step 2 #}
{% set prod_new_div = 'fas_new_div' %}
{% set prod_list_div_id = 'fas_prod_div' %}
{% set prod_new_tbl_id = 'fas_prod_new_tbl' %}

{% set prod_db_tbl_id = 'fas_prod_db_tbl' %}

{# Step 3 #}
{% set vec_list_div_id = 'fas_inv_vec_list_div' %}

{% block stylesheets %}
    {% stylesheets '@CraueFormFlowBundle/Resources/assets/css/buttons.css' %}
        <link type="text/css" rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
    
    {% stylesheets '@MorusFasBundle/Resources/public/css/jquery-ui.min.css' %}
        <link type="text/css" rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
{% endblock %}

{% block javascripts %}
    {% javascripts 
        '@MorusFasBundle/Resources/public/js/jquery-1.9.1.min.js'
        '@MorusFasBundle/Resources/public/js/jquery-ui.min.js'
        '@MorusFasBundle/Resources/public/js/jquery.inputmask.js'
        '@MorusFasBundle/Resources/public/js/jquery.inputmask.numeric.extensions.js'
    %}
        <script type="text/ecmascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}

    <script type='text/javascript'>
    {% if flow.getCurrentStepNumber() == 2 %}
        // ==========================================
        // New Product JQuery Function
        // ==========================================
        var $prodDlg //Dialog Box
        var $prodForm // Product Form
        
        jQuery(document).ready(function() {
            $prodDlg = $( "#{{ prod_dlg_div_id }}" );
            $prodForm = $('#{{ parts_form.vars.attr.id }}');
            
            refreshProductList();
            
            // Init New Product Dialog Box
            $prodDlg.dialog({
                autoOpen: false, height: 200, width: 500, modal: true,
                buttons: {
                    "{{ 'btn.save'|trans }}": function() {
                        var btn_id = $prodDlg.data('btn_id');
                        postForm( $prodForm, function( response ) {
                            if (response.success) {
                                $('button[id="' + btn_id + '"]').replaceWith(
                                    {% image '@MorusFasBundle/Resources/public/images/ok_icon_16x16.png' %}
                                        "<img src='{{ asset_url }}' alt='OK' style='width: 16px'/>"
                                    {% endimage %}
                                );
                                refreshProductList();
                                $prodDlg.dialog( "close" );
                            } else {
                                alert('Error adding product to database, please try again.');
                            }

                        });
                    },
                    "{{ 'btn.cancel'|trans }}": function() {
                        $prodDlg.dialog( "close" );
                    }
                },
                show: { effect: "fade", duration: 500 },
                hide: { effect: "fade", duration: 500 }
            });
            
            // Add New Item button
            $( 'button[id^="{{ prod_dlg_btn_prfx }}"]' ).on('click', function( event ){
                event.preventDefault();
                
                var index = this.id.substring(this.id.lastIndexOf('_') + 1);
                var itemcode = this.id.replace("{{ prod_dlg_btn_prfx }}","").replace('_' + index, "" );
                var itemname = this.name;
                $prodForm.find('#{{ prod_dlg_idx_id }}').val(index);
                $prodForm.find('#{{ parts_form.itemcode.vars.id }}').val(itemcode);
                $prodForm.find('#{{ parts_form.itemname.vars.id }}').val(itemname);
                $prodForm.find('#{{ parts_form.defaultDiscount.vars.id }}').val('');
                
                $prodDlg.data('btn_id', this.id)
                        .dialog( "open" );
            });
            
            // Apply input mask to default discount box
            $('#{{ parts_form.defaultDiscount.vars.id }}').inputmask("decimal", { 
                radixPoint: ".", groupSeparator: ",", groupSize: 3, digits: 2,
                autoGroup: true, placeholder: "0.00"
            });
        });
        
        // Post Form and get result
        function postForm( $form, callback ){

            // Get all form values
            var values = {};
            var index = $form.find('#{{ prod_dlg_idx_id }}').val();
            values['index'] = index;
            $.each( $form.serializeArray(), function(i, field) {
              values[field.name] = field.value;
            });

            // Throw the form values to the server
            $.ajax({
                type        : $form.attr( 'method' ),
                url         : $form.attr( 'action' ),
                data        : values,
                success     : function(response) {
                    callback( jQuery.parseJSON(response) );
                }
            });
        }
        
        // Make Ajax Call to refresh Customer Vehicle List 
        function refreshProductList() { 
            var parts = {};
                
            {% for key, value in flow.stmtProdList %}
            parts['{{ key }}'] = '{{ value }}';
            {% endfor %}

            var values = {};
            values['parts'] = parts;

            $.ajax({
                url         : "{{ path('morus_fas_statement_export_parts_list')}}",
                type        : "GET",
                data        : values,
                success     : function(data) {
                    $('#{{ prod_list_div_id }}').html(data);
                }
            });
        }
        
    {% elseif flow.getCurrentStepNumber() == 3 %}
        var $vecDlg, $vecBtn //Dialog Box & Trigger Button
        var $vecDlgLicUl; // Licence List in Dialog box
        var $vecDlgCustSelect; //Customer Combo Box
        var $addChoice = 'existing'; // Hold Option for adding vehicle to "new" or "existing" customer
        var $vecListDiv; // Registered Vehicle List
        
        // ==========================================
        // Assign Vehicle JQuery Function
        // ==========================================
        function refreshUnitVehicleList() { // Make Ajax Call to refresh Customer Vehicle List 
            var licences = {};
                
            {% for key, value in flow.stmtVecList %}
            licences['{{ key }}'] = '{{ value }}';
            {% endfor %}

            var values = {};
            values['registration_numbers'] = licences;

            $.ajax({
                url         : "{{ path('morus_fas_statement_export_unit_vehicle_list')}}",
                type        : "GET",
                data        : values,
                success     : function(data) {
                    $('#{{ vec_list_div_id }}').html(data);
                }
            });
        }
        
        // Post Form and get result
        function addVehicleToUnit( unitId, licences, callback ){
            // Get all form values
            var values = {};

            values['id'] = unitId;
            values['licences'] = licences;

            // Throw the form values to the server
            $.ajax({
                url         : "{{ path('morus_fas_statement_add_vehicle_to_customer_ajax') }}",
                type        : "POST",
                data        : values,
                success     : function(response) {
                    callback( jQuery.parseJSON(response) );
                }
            });
        }
            
        jQuery(document).ready(function() {
            $vecListDiv = $('#{{ vec_list_div_id }}');
            $vecDlg = $( '#{{ vec_dlg_div_id }}' );
            $vecBtn = $( '#{{ vec_dlg_btn_id }}');
            $vecDlgLicUl = $( '#{{ vec_dlg_lic_ul_id }}');
            $vecDlgCustSelect = $( '#{{ vec_dlg_cust_select_id }}');
            
            refreshUnitVehicleList();
            $vecDlg.css({overflow:"auto"}); // Make dialog scrollable
            $vecDlg.dialog({ //Init Dialog Box
                autoOpen: false, height: 300, width: 900, modal: true,
                buttons: {
                    "{{ 'btn.save'|trans }}": function() {
                        var licAry = $vecDlg.data('licences');
                        
                        if ($addChoice === 'existing') {
                            var unitname = $vecDlgCustSelect.find('option:selected').text();
                            var unitid = $vecDlgCustSelect.find('option:selected').val();
                            
                            addVehicleToUnit( unitid, licAry, function( response ) {
                                if (response.success) {
                                    $.each(licAry, function(key, value){
                                        $('input[id="'+key+'"]').replaceWith(
                                            {% image '@MorusFasBundle/Resources/public/images/ok_icon_16x16.png' %}
                                                "<img src='{{ asset_url }}' alt='OK' style='width: 16px'/>"
                                            {% endimage %}
                                        );
                                    });
                                    refreshUnitVehicleList();
                                    $vecDlg.dialog( "close" );
                                }
                            });
                            
                        } else if ($addChoice === 'new') {
                            $vecDlg.dialog( "close" );
                        } 
                        
                    },
                    "{{ 'btn.cancel'|trans }}": function() {
                        $vecDlg.dialog( "close" );
                    }
                },
                show: { effect: "fade", duration: 500 },
                hide: { effect: "fade", duration: 500 }
            });
            
            // New Unit Popup Button
            $vecBtn.on('click', function(event){
                event.preventDefault();
                
                //  Get selected licences
                var licAry = {};
                $('input[name="licence_number_input"]:checked').each(function(event) {
                    licAry[this.id] = this.value;
                 });
                
                // Show Licences to dialog box list
                $vecDlgLicUl.empty();
                $.each(licAry, function(key, value){
                    $vecDlgLicUl.append('<li>'+value+'</li>'); 
                });
                
                
                $vecDlg.data('licences', licAry)
                        .dialog( "open" );
            });
            
            // Choose Customer Radio Button
            $('input[id="{{ vec_dlg_cust_radio_id }}"]').change(function(){
                if (this.value === 'new') {
                    $('#{{ vec_dlg_cust_new_div_id }}').show();
                    $('#{{ vec_dlg_exist_cust_div_id }}').hide();
                    $addChoice = this.value;
                } else {
                    $('#{{ vec_dlg_cust_new_div_id }}').hide();
                    $('#{{ vec_dlg_exist_cust_div_id }}').show();
                    $addChoice = this.value;
                }
            })
        });
    {% endif %}
    
    </script>
{% endblock %}

{% block body_title -%}
    {{ 'statement.export_invoice'|trans }}
{% endblock %}

{% block body -%}
    
    <div>
        {% include 'CraueFormFlowBundle:FormFlow:stepList.html.twig' %}
    </div>
    {{ form_start(export_form) }}
        {{ form_errors(export_form) }}        
        
        {% if flow.getCurrentStepNumber() == 1 %} {# Analysis Statement #}
            Total Product Discovered: {{ flow.stmtProdList|length }}<br/>
            
            Total Vehicle Discovered: {{ flow.stmtVecList|length }}<br/>
            
            Total record procssed: {{ flow.stmtRowCnt }} row.<br/>
            
            click next to continue.
            
        {% elseif flow.getCurrentStepNumber() == 2 %}  {# Query Product #}
            {# Listing Existing Unit with Vehicle Number #}
            <div id="{{ prod_list_div_id }}" style="float: left">
                {# Please see /Statement/export_product_list.html.twig #}
            </div> 

            {# Listing New Product #}
            <div id="{{ prod_new_div }}"  style="float: right">
                <h3>{{ 'export_step.new_product'|trans }}</h3>
                <table id="{{ prod_new_tbl_id }}">
                    {% for itemcode, itemname in flow.newProdList %}
                        <tr id="{{ loop.index }}">
                            <td>
                                {% image '@MorusFasBundle/Resources/public/images/new_icon.png' %}
                                    <img src="{{ asset_url }}" alt="OK" style="width: 25px"/>
                                {% endimage %}
                            </td>
                            <td>{{ itemname }}</td>
                            <td>
                                <button id="{{ prod_dlg_btn_id|replace({'%itemcode%' : itemcode, '%index%' : loop.index}) }}" name="{{ itemname }}"  />+</button>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        {% elseif flow.getCurrentStepNumber() == 3 %}  {# Query Licence #}
            {# Listing Existing Unit with Vehicle Number #}
            <div id="{{ vec_list_div_id }}" style="float: left">
                {# Please see /Statement/export_unit_vehicle_list.html.twig #}
            </div> 
            
            {# Display New Vehicle Number #}
            <div style="float: right">
                <a id="{{ vec_dlg_btn_id }}" href="#">{{ 'btn.register_to_customer'|trans }}</a>
                <table>
                    {% for row in flow.newVecList|batch(5) %}
                        <tr>
                            {% for veccode, vecname in row %}
                            <td>
                                <input id="{{ veccode }}" name="licence_number_input" type="checkbox" value="{{ vecname }}" />{{ vecname }}
                            </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </table>
            <div>
            
        {% elseif flow.getCurrentStepNumber() == 4 %}  {# Summary Step #}
            
            
            
        {% endif %}

        {{ form_rest(export_form) }}

        {% include 'CraueFormFlowBundle:FormFlow:buttons.html.twig' %}
    {{ form_end(export_form) }} 
    
    {#  New Product Popup #}
    <div id="{{ prod_dlg_div_id }}" title="{{ 'inventory.new_inventory_item'|trans }}" style="display:none">  
        {{ form_start(parts_form) }}
            {{ form_errors(parts_form) }}
            <input type="hidden" id="{{ prod_dlg_idx_id  }}" value="" />
            {{ 'inventory.itemcode'|trans }} {{ form_widget(parts_form.itemcode) }}{{ form_errors(parts_form.itemcode) }}
            {{ 'inventory.itemname'|trans }} {{ form_widget(parts_form.itemname) }} {{ form_errors(parts_form.itemname) }}
            <hr/>
            {{ 'inventory.default_discount'|trans }} {{ form_widget(parts_form.defaultDiscount) }}
            <br/>
            {{ form_widget( parts_form.submit ) }}
            {{ form_rest(parts_form) }}
        {{ form_end(parts_form) }}
    </div>
    
    {# Assign Licence to Customer Popup #}
    <div id="{{ vec_dlg_div_id }}" title="{{ 'contact.add_contact'|trans }}" style="display:none">
        <div id="container-box" class="contact-new">
            <div class="section-form inset form">
                {# Division to hold licence numbers #}
                <div>
                    {{ 'statement.selected_licence_list'|trans }} :
                    <ul id="{{ vec_dlg_lic_ul_id }}">

                    </ul>
                </div>
                {{ 'statement.add_to'|trans }}
                <fieldset >
                    <input type="radio" id="{{ vec_dlg_cust_radio_id }}" name="{{ vec_dlg_cust_radio_id }}"  value="existing" checked="checked" >{{ 'statement.existing_customer'|trans }}</input>
                    <input type="radio" id="{{ vec_dlg_cust_radio_id }}" name="{{ vec_dlg_cust_radio_id }}"  value="new">{{ 'statement.new_customer'|trans }}</input>
                </fieldset>

                
                {# Division for existing customer #}
                <div id="{{ vec_dlg_exist_cust_div_id }}" >
                    <select id="{{ vec_dlg_cust_select_id }}">
                        {% for unit in existing_units %}
                            <option value="{{ unit.id }}" >{{ unit.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                {# Division for creating new customer #}
                <div id="{{ vec_dlg_cust_new_div_id }}" style="display:none">
                    {{ form_start(unit_form) }}
                    {{ form_errors(unit_form) }}
                        <fieldset>
                            <div class="field long">
                                <label>{{ 'contact.display_name'|trans }}</label>

                                {{ form_widget(unit_form.name) }} {{ form_errors(unit_form.name) }}
                            </div>
                        </fieldset>


                        <div id="entity_persons" data-prototype-persons="">
                            {% for person in unit_form.persons %}
                                {% if loop.index == 1 %}
                                    <h4>{{ 'contact.primary_person'|trans }}</h4>
                                {% endif %}
                                <div id="entity_person_contacts" data-prototype-contacts="">
                                    <fieldset>
                                        {{ form_widget(person) }}
                                        {% for contact in person.contacts %}
                                            <div class="field inline long">{{ form_widget(contact) }}</div>
                                        {% endfor %}
                                    </fieldset>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="column">

                            {% for location in unit_form.locations %}
                                {{ form_widget(location) }}
                            {% endfor %}

                            <div class="col-1-3 last">
                                <fieldset id="numbers">
                                    <h6>{{ 'contact.others'|trans }}</h6>
                                    {% for contact in unit_form.contacts %}
                                        <div class="field">{{ form_widget(contact) }}</div>
                                    {% endfor %}
                                </fieldset>
                            </div>

                        </div>

                        <div>

                        </div>
                        {{ form_widget(unit_form.submit) }}

                        {{ form_rest(unit_form) }}
                    {{ form_end(unit_form) }}
                </div>
            </div>
        </div>
    </div>
        
{% endblock %}
